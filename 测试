import streamlit as st
import random
import time

# --- é¡µé¢é…ç½® ---
st.set_page_config(
    page_title="COD Universe: Life Simulator",
    page_icon="ğŸª–",
    layout="wide",
    initial_sidebar_state="expanded"
)

# --- è‡ªå®šä¹‰ CSS (è®©ç•Œé¢æ›´æœ‰ COD æˆ˜æœ¯é£æ ¼) ---
st.markdown("""
<style>
    .stApp {
        background-color: #0e1117;
        color: #fafafa;
    }
    .stButton>button {
        background-color: #2E7D32; /* æˆ˜æœ¯ç»¿ */
        color: white;
        border-radius: 5px;
        border: none;
        width: 100%;
    }
    .stButton>button:hover {
        background-color: #1B5E20;
    }
    .log-text {
        font-family: 'Courier New', monospace;
        padding: 10px;
        border-left: 2px solid #4CAF50;
        background-color: #1e1e1e;
        margin-bottom: 5px;
    }
    .highlight-141 { color: #90CAF9; font-weight: bold; } /* TF141 è“è‰² */
    .highlight-kortac { color: #FFAB91; font-weight: bold; } /* KorTac æ©™è‰² */
    .highlight-enemy { color: #EF5350; font-weight: bold; } /* æ•Œå¯¹ çº¢è‰² */
    .highlight-romance { color: #F48FB1; font-weight: bold; } /* æ‹çˆ± ç²‰è‰² */
</style>
""", unsafe_allow_html=True)

# --- æ•°æ® ---
COD_CHARACTERS = {
    "TF141": ["Captain Price", "Soap", "Ghost", "Gaz"],
    "KorTac": ["KÃ¶nig", "Horangi"],
    "Chimera": ["Krueger", "Nikto", "Nikolai"],
    "Villains": ["General Shepherd", "Makarov", "Valeria"]
}

# --- æ ¸å¿ƒé€»è¾‘å‡½æ•° ---

def get_relationship_desc(score):
    if score > 80: return "ã€çµé­‚ä¼´ä¾£/ç”Ÿæ­»ä¹‹äº¤ã€‘"
    if score > 50: return "ã€äº²å¯†æˆ˜å‹ã€‘"
    if score > 20: return "ã€ç†Ÿäººã€‘"
    if score < -50: return "ã€æ­»æ•Œã€‘"
    if score < -20: return "ã€å…³ç³»ç´§å¼ ã€‘"
    return "ã€ç‚¹å¤´ä¹‹äº¤ã€‘"

def generate_life(name, gender, start_age, looks):
    logs = []
    relationships = {char: 0 for faction in COD_CHARACTERS.values() for char in faction}
    is_alive = True
    
    logs.append(f"ğŸ“ **æ¡£æ¡ˆå»ºç«‹**: {name} | æ€§åˆ«: {gender}")
    logs.append(f"ğŸ‘ï¸ **å¤–è²Œç‰¹å¾**: {looks}")
    logs.append("---")
    
    for age in range(start_age, 100):
        if not is_alive:
            break

        # æ­»äº¡åˆ¤å®š
        death_base = 0.005 if age < 50 else (age - 50) * 0.002
        if age > 80: death_base += 0.1
        if random.random() < death_base:
            causes = ["åœ¨ä¸€æ¬¡ç§˜å¯†è¡ŒåŠ¨ä¸­å…‰è£ç‰ºç‰²", "å› æ—§ä¼¤å¤å‘åœ¨åŒ»é™¢å»ä¸–", "åœ¨ç¡æ¢¦ä¸­å®‰è¯¦ç¦»ä¸–", "ä¸ºäº†æ©æŠ¤é˜Ÿå‹æ’¤ç¦»å¼•çˆ†äº†æ‰‹é›·"]
            logs.append(f"ğŸ’€ **{age}å²**: ä½ {random.choice(causes)}ã€‚")
            is_alive = False
            break
        
        # äº‹ä»¶ç”Ÿæˆé€»è¾‘
        event_text = ""
        
        # ç«¥å¹´
        if age < 18:
            if random.random() < 0.3:
                child_events = ["æ¡åˆ°ä¸€æšåºŸå¼ƒå¼¹å£³", "åœ¨å­¦æ ¡ä¸ºäº†ä¿æŠ¤æœ‹å‹æ‰“æ¶", "çœ‹å†›äº‹çºªå½•ç‰‡å…¥è¿·"]
                event_text = f"ğŸ‘¶ **{age}å²**: {random.choice(child_events)}ã€‚"

        # å‚å†›
        elif age == 18:
            event_text = f"ğŸª– **{age}å²**: **ä½ æˆå¹´å¹¶å‚å†›äº†**ã€‚æ¬¢è¿æ¥åˆ°ä½¿å‘½å¬å”¤çš„ä¸–ç•Œã€‚"

        # æœå½¹æœŸ
        elif 18 < age < 60:
            # éšæœºäº’åŠ¨
            if random.random() < 0.6:
                faction_key = random.choice(list(COD_CHARACTERS.keys()))
                char = random.choice(COD_CHARACTERS[faction_key])
                
                # CSS æ ·å¼æ ‡è®°
                char_span = f"<span class='highlight-141'>{char}</span>" if faction_key == "TF141" else \
                            f"<span class='highlight-kortac'>{char}</span>" if faction_key == "KorTac" else char
                
                dice = random.random()
                
                # è°¢è²å°”å¾·ç‰¹æ®Šäº‹ä»¶
                if char == "General Shepherd" and dice < 0.1:
                    event_text = f"âš ï¸ **{age}å²**: <span class='highlight-enemy'>Shepherd</span> è®©ä½ å»é”€æ¯ä¸€äº›æ–‡ä»¶ï¼Œä½ è§‰å¾—ä»–åœ¨éšç’ä»€ä¹ˆã€‚ (å…³ç³»ä¸‹é™)"
                    relationships[char] -= 20
                
                # æ‹çˆ±/æš§æ˜§ (å¥½æ„Ÿåº¦é«˜)
                elif dice < 0.15 and relationships[char] > 30:
                    relationships[char] += 15
                    romance_events = [f"åœ¨æ’¤ç¦»æœºä¸Šç´§æ¡ä½ä½ çš„æ‰‹", f"åœ¨æ·±å¤œä¸ºä½ åŒ…æ‰ä¼¤å£", f"é€äº†ä½ ä¸€æŠŠå®šåˆ¶çš„æˆ˜æœ¯åŒ•é¦–"]
                    event_text = f"â¤ï¸ **{age}å²**: {char_span} {random.choice(romance_events)}ã€‚"
                
                # å†²çª
                elif dice < 0.3:
                    relationships[char] -= 10
                    conflict_events = ["è´¨ç–‘ä½ çš„æˆ˜æœ¯", "åœ¨é£Ÿå ‚å’Œä½ åµæ¶", "æŠ¢äº†ä½ çš„å‡»æ€"]
                    event_text = f"ğŸ’¢ **{age}å²**: ä½ å’Œ {char_span} {random.choice(conflict_events)}ã€‚"
                
                # å‹æƒ…/ä»»åŠ¡
                else:
                    relationships[char] += 8
                    friend_events = ["äº’ç›¸æ©æŠ¤", "ä¸€èµ·å–ä¼ç‰¹åŠ ", "äº¤æ¢äº†æ­¦å™¨é…ä»¶", "æŠŠä½ ä»åºŸå¢Ÿé‡Œæ‹‰å‡ºæ¥"]
                    event_text = f"ğŸ¤ **{age}å²**: {char_span} {random.choice(friend_events)}ã€‚"

        # é€€ä¼‘
        else:
            if random.random() < 0.3:
                old_events = ["æ—§ä¼¤éšéšä½œç—›", "Price æ¥çœ‹æœ›ä½ ", "åœ¨å†›äº‹å­¦é™¢è®²è¯¾"]
                event_text = f"â˜• **{age}å²**: {random.choice(old_events)}ã€‚"

        if event_text:
            logs.append(event_text)

    return logs, relationships, is_alive

# --- ä¾§è¾¹æ ï¼šç”¨æˆ·è¾“å…¥ ---
with st.sidebar:
    st.header("ğŸ› ï¸ è§’è‰²åˆ›å»º")
    
    # éšæœºæŒ‰é’®é€»è¾‘
    if "name_input" not in st.session_state: st.session_state.name_input = ""
    if "looks_input" not in st.session_state: st.session_state.looks_input = ""
    
    def randomize():
        firsts = ["Soap", "Roach", "Frost", "Sandman", "Yuri", "Echo"]
        lasts = ["MacTavish", "Sanderson", "Allen", "Riley"]
        st.session_state.name_input = f"{random.choice(firsts)} {random.choice(lasts)}"
        st.session_state.looks_input = random.choice(["å·¦çœ¼æœ‰ç–¤", "æ€»æ˜¯æˆ´é¢ç½©", "éª·é«…çº¹èº«", "æœºæ¢°ä¹‰è‚¢"])
    
    st.button("ğŸ² éšæœºç”Ÿæˆå±æ€§", on_click=randomize)

    name = st.text_input("å§“å", key="name_input")
    gender = st.selectbox("æ€§åˆ«", ["ç”·", "å¥³", "ä¿å¯†"])
    age_start = st.slider("åˆå§‹å¹´é¾„", 1, 90, 1)
    looks = st.text_input("å¤–è²Œæè¿°", key="looks_input")
    
    st.markdown("---")
    run_btn = st.button("ğŸš€ å¼€å§‹æ¨¡æ‹Ÿäººç”Ÿ")

# --- ä¸»ç•Œé¢æ˜¾ç¤º ---
st.title("ğŸ”« COD ä¸–ç•Œè§‚: äººç”Ÿæ¨¡æ‹Ÿå™¨")

if run_btn:
    if not name: name = "Unknown Soldier"
    if not looks: looks = "Standard Issue"
    
    # è¿è¡Œæ¨¡æ‹Ÿ
    with st.spinner('æ­£åœ¨è¿æ¥ä½¿å‘½å¬å”¤æŒ‡æŒ¥éƒ¨æ•°æ®åº“...'):
        time.sleep(0.8) # å‡è£…åŠ è½½ï¼Œå¢åŠ ä»ªå¼æ„Ÿ
        logs, rels, alive = generate_life(name, gender, age_start, looks)
    
    # åˆ†æ æ˜¾ç¤ºï¼šå·¦è¾¹æ˜¯æ—¥å¿—ï¼Œå³è¾¹æ˜¯æœ€ç»ˆçŠ¶æ€
    col1, col2 = st.columns([2, 1])
    
    with col1:
        st.subheader("ğŸ“œ ç”Ÿæ¶¯å±¥å†")
        for log in logs:
            # ä½¿ç”¨ HTML æ¸²æŸ“æ¥å®ç°é¢œè‰²
            st.markdown(f"<div class='log-text'>{log}</div>", unsafe_allow_html=True)
            time.sleep(0.05) #ä»¥æ­¤äº§ç”Ÿæ‰“å­—æœºæ•ˆæœ
            
    with col2:
        st.subheader("ğŸ“Š äººé™…å…³ç³»ç»“ç®—")
        sorted_rels = sorted(rels.items(), key=lambda x: x[1], reverse=True)
        
        # å­˜æ´»çŠ¶æ€
        status_color = "green" if alive else "red"
        status_text = "ç°å½¹ / é€€ä¼‘" if alive else "é˜µäº¡ (KIA)"
        st.markdown(f"### çŠ¶æ€: :{status_color}[{status_text}]")
        
        st.write("---")
        for char, score in sorted_rels:
            if score != 0:
                # è¿›åº¦æ¡æ˜¾ç¤ºå¥½æ„Ÿåº¦
                norm_score = min(max((score + 100) / 200, 0.0), 1.0) # å½’ä¸€åŒ–åˆ°0-1
                st.write(f"**{char}**: {score}")
                st.progress(norm_score)
                st.caption(get_relationship_desc(score))

else:
    st.info("ğŸ‘ˆ è¯·åœ¨å·¦ä¾§ä¾§è¾¹æ è¾“å…¥ä¿¡æ¯å¹¶ç‚¹å‡»â€œå¼€å§‹æ¨¡æ‹Ÿäººç”Ÿâ€")
    st.image("https://media.giphy.com/media/fX1ZTHoabK67XRqXQU/giphy.gif", caption="Task Force 141 ç­‰å¾…ä½ çš„åŠ å…¥")
